<!doctype html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <title>Ìè¥Îçî Î≥¥Í∏∞</title>
        <style>
            .grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 10px;
            }
            .grid img {
                width: 100%;
            }
            textarea {
                width: 100%;
                margin-top: 20px;
                min-height: 100px;
                overflow: hidden;
                resize: none;
                box-sizing: border-box;
                font-size: 16px;
                padding: 8px;
            }
            button {
                margin-top: 10px;
                padding: 10px 20px;
                background: blue;
                color: white;
                border: none;
                border-radius: 5px;
            }

            /* ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº Ïä§ÌÉÄÏùº */
            .nav-buttons {
                margin-top: 20px;
                display: flex;
                justify-content: space-between;
            }
            .nav-buttons button {
                padding: 10px 15px;
                background-color: #4caf50;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }
            .nav-buttons button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
        </style>
    </head>
    <body>
        <h1 id="folder-name"></h1>
        <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº -->
        <div class="nav-buttons">
            <button id="prev-btn" onclick="navigateFolder('prev')">Ïù¥Ï†Ñ Ìè¥Îçî</button>
            <button id="next-btn" onclick="navigateFolder('next')">Îã§Ïùå Ìè¥Îçî</button>
        </div>

        <div class="grid" id="image-grid">
            <!-- Ïù¥ÎØ∏ÏßÄÍ∞Ä Ïó¨Í∏∞Ïóê Îì§Ïñ¥Í∞ê -->
        </div>

        <textarea id="note" placeholder="Ïó¨Í∏∞Ïóê Í∏ÄÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî"></textarea>
        <br />
        <button id="copy-btn">Î≥µÏÇ¨ÌïòÍ∏∞</button>
        <!-- Ï∂îÍ∞ÄÎêú Î≥µÏÇ¨ Î≤ÑÌäº -->

        <script>
            const server = "";
            const note = document.getElementById("note");
            const prevBtn = document.getElementById("prev-btn");
            const nextBtn = document.getElementById("next-btn");
            const pathParts = window.location.pathname.split("/");
            const folder = pathParts[1];
            // URL Í≤ΩÎ°úÏóêÏÑú Ìè¥Îçî Ïù¥Î¶Ñ Ï∂îÏ∂ú
            document.getElementById("folder-name").textContent = `Ìè¥Îçî: ${folder}`;

            function autoResize() {
                note.style.height = "auto";
                note.style.height = note.scrollHeight + "px";
            }

            note.addEventListener("input", () => {
                autoResize();
                triggerAutoSave();
            });

            let prev;
            let next;

            fetch(`${server}/${folder}/prev`)
                .then((res) => res.json())
                .then((r) => {
                    console.log(r);
                    prev = r.page;
                });

            fetch(`${server}/${folder}/next`)
                .then((res) => res.json())
                .then((r) => {
                    console.log(r);
                    next = r.page;
                });

            // Ïù¥ÎØ∏ÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
            fetch(`${server}/${folder}/images`)
                .then((res) => res.json())
                .then((images) => {
                    const grid = document.getElementById("image-grid");
                    images.forEach((img) => {
                        const dv = document.createElement("div");
                        const lab = document.createElement("p");
                        const imgEl = document.createElement("img");
                        imgEl.src = `/static${server}/${folder}/${img}`;
                        lab.textContent = img;
                        dv.appendChild(lab);
                        dv.appendChild(imgEl);
                        grid.appendChild(dv);
                    });
                });

            // üî• ÏûêÎèô Ï†ÄÏû• Í¥ÄÎ†®
            let saveTimer = null;

            function triggerAutoSave() {
                if (saveTimer) clearTimeout(saveTimer);

                saveTimer = setTimeout(() => {
                    saveNote();
                }, 100); // ÏûÖÎ†• ÌõÑ 2Ï¥à ÏßÄÎÇòÎ©¥ Ï†ÄÏû•
            }

            function saveNote() {
                const content = note.value;

                fetch("/save", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ folder, content }),
                })
                    .then(() => {
                        console.log("‚úÖ ÏûêÎèô Ï†ÄÏû• ÏôÑÎ£å");
                    })
                    .catch((err) => {
                        console.error("‚ùå Ï†ÄÏû• Ïã§Ìå®", err);
                    });
            }

            // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∏Ä Î∂àÎü¨Ïò§Í∏∞
            window.addEventListener("load", () => {
                autoResize();

                fetch(`${server}/${folder}/note`)
                    .then((res) => (res.ok ? res.text() : ""))
                    .then((text) => {
                        note.value = text;
                        autoResize();
                    });
            });

            // Ïù¥Ï†Ñ/Îã§Ïùå Ìè¥ÎçîÎ°ú Ïù¥Îèô
            function navigateFolder(direction) {
                if (direction === "prev") {
                    window.location.pathname = `/${prev}`;
                } else if (direction === "next") {
                    window.location.pathname = `/${next}`;
                }
            }

            const copyBtn = document.getElementById("copy-btn");

            copyBtn.addEventListener("click", () => {
                navigator.clipboard
                    .writeText(note.value)
                    .then(() => {
                        window.open(`https://cafe.naver.com/ca-fe/cafes/31319729/articles/${folder}?commentFocus=true`, "_blank");
                    })
                    .catch((err) => {});
            });
        </script>
    </body>
</html>
